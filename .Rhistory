vars_money9a <- str_c(vars_money, "9a")
varindex9a <- str_c(varindex, "9a")
# if a value is 0 at the beginning of the period, rate of change will be infinite
# those values need to be recoded to NA
tracts2017 %<>%
# mutate(mhmval9a = ifelse(is.na(mhmval9a), min(mhmval9a, na.rm = T), mhmval9a),
#        mrent9a = ifelse(is.na(mrent9a), min(mrent9a, na.rm = T), mrent9a),
#        hinc9a = ifelse(is.na(hinc9a), min(hinc9a, na.rm = T), hinc9a),
#        pop9a = ifelse(pop9a < 1 | is.na(pop9a), 1, pop9a),
#        hu9a = ifelse(hu9a < 1 | is.na(hu9a), 1, hu9a)) %>%
#mutate_at(all_of(varindex9a[c(3:length(varindex9a)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex9a[c(3:(length(varindex9a)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
tracts1017 <- left_join(tracts2010, tracts2017 %>% select(trtid10, pop9a:hh9a), by = "trtid10")
rm(tracts2010, tracts2017)
summary(tracts1017)
# separate varindex for percent versus whole values ####
pctvarindex <- c("pnhwht", "pnhblk", "phisp", "pmulti", "pcol", "ppov", "pprof",
"p20young", "pown", "pvac", "pfb")
varindex <- c("pop", "hu", "hh", "mhmval", "mrent", "hinc")
for (variable in pctvarindex) {
tracts1017[[paste0(variable, "_change")]] <-
((tracts1017[[paste0(variable, "9a")]] - tracts1017[[paste0(variable, "2a")]]))/7
tracts1017[[paste0(variable, "8a")]] <-
tracts1017[[paste0(variable, "9a")]]+tracts1017[[paste0(variable, "_change")]]
tracts1017[[paste0(variable, "2019")]] <-
tracts1017[[paste0(variable, "9a")]]+tracts1017[[paste0(variable, "_change")]]*2
}
for (variable in varindex) {
tracts1017[[paste0(variable, "_change")]] <-
((tracts1017[[paste0(variable, "9a")]] - tracts1017[[paste0(variable, "2a")]])/tracts1017[[paste0(variable, "2a")]])/7
tracts1017[[paste0(variable, "8a")]] <-
tracts1017[[paste0(variable, "9a")]]*(1+tracts1017[[paste0(variable, "_change")]])
tracts1017[[paste0(variable, "2019")]] <-
tracts1017[[paste0(variable, "9a")]]*(1+tracts1017[[paste0(variable, "_change")]])^2
}
tracts2017 <- tracts1017 %>%
select(c(1:8, ends_with("9a"))) %>%
mutate(Year = "2017",
prent9a = 100-pown9a)
names(tracts2017) <- gsub("9a", "", names(tracts2017))
# varindex of needed variables to top/bottom-code  ####
varindex <- c("pop", "hu", "pnhwht", "pnhblk", "pmulti", "pcol", "ppov", "pprof",
"p20young", "pown", "pvac", "pfb", "mhmval", "mrent", "hinc", "hh")
tracts2018 <- tracts1017 %>%
select(c(1:8, ends_with("8a")))
names(tracts2018) <- gsub("8a", "", names(tracts2018))
tracts2018 %<>%
mutate(#mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc),
#pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#hu = ifelse(hu < 1 | is.na(hu), 1, hu),
Year = "2018") %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .))) %>%
mutate(prent = 100-pown)
tracts2019 <- tracts1017 %>%
select(c(1:8, ends_with("2019")))
names(tracts2019) <- gsub("2019", "", names(tracts2019))
tracts2019 %<>%
mutate(#mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc),
#pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#hu = ifelse(hu < 1 | is.na(hu), 1, hu),
Year = "2019") %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .))) %>%
mutate(prent = 100-pown)
tracts9019 <- base::rbind(tracts9000, tracts0010 %>% filter(Year != "2000"), tracts2017, tracts2018, tracts2019)
rm(list = ls())
#### updates log ----------
# 5/16: incorporate new bottom-/top-coding scheme
# 6/9: remember to interpolate if there are missing values in intervening years
# 6/15: add in intervening years for PSID (incl. 1990) and make MSA-level
# 7/5: update bottom-coding by Census/ACS year-specific values and do metdiv crosswalk
# 7/6-7/7: remove bottom-coding entirely; do weighted quantiles by # of households ("hh")
# 11/9: add in 1970 and 1980, remove hisp bc doesn't exist in 1970
# rename black and white for 1970 to be nhwhite and nhblack
rm(list = ls())
# interpolation scheme:
# Set 2008-2012 as 2010, and interpolate for 2005-2009 with 2000 Census
# set 2015-2019 as 2017, and interpolate for 2018 and 2019 using 2010-2017 rate of change
# cpi to 2019 Jan 1$ (1970 (1969), 1980 (1979), 1990 (1989), 2000 (1999), 2010(2012), 2011(2013), 2012(2014), 2013(2015), 2014(2016), 2015(2017), 2016(2018), 2017(2019))
# c(2.08, 1.53, 1.11, 1.09, 1.08, 1.08, 1.06, 1.04, 1.02)
cpi <- c(7.07, 3.69, 2.08, 1.53, 1.11, 1.09, 1.08, 1.08, 1.06, 1.04, 1.02, 1)
names(cpi) <- c("1970", "1980", "1990", "2000", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017")
names(cpi)
homedir <- paste0(dirname(rstudioapi::getSourceEditorContext()$path))
workdir <- paste0("/../misc_data/")
setwd(paste0(homedir, workdir))
library(tidyverse)
library(foreign)
library(readr)
library(magrittr)
library(zoo)
library(Hmisc)
# this file is not on Github because it is too large; it is, however, on my local Git in the workdir
# it can be downloaded here: https://www.dropbox.com/sh/7inh5jw6cx5k9dh/AABWwI61jSpUllhB3Zn7ijM3a/Aggregated%20Longitudinal%20Datasets?dl=0&subfolder_nav_tracking=1.
neighborhoods <- read_csv('ltdb7010_acs1519_2010boundaries_merge_clean_full.csv')
names(neighborhoods)
neighborhoods %<>%
select(c(1:8, ends_with("70"), ends_with("80"), ends_with("90"), ends_with("00"), ends_with("2a"), ends_with("9a")))
#vars needed
neighborhoods %<>%
rename(pnhwht70 = pwhite70,
pnhblk70 = pblack70)
varindex <- c("pop", "hu", "pnhwht", "pnhblk", "pmulti", "pcol", "ppov", "pprof",
"p20young", "pown", "pvac", "pfb", "mhmval", "mrent", "hinc", "hh")
vars_money <- c("mhmval", "mrent", "hinc")
#years needed
yearsindex <- c("70", "80", "90", "00", "2a", "9a")
varnames <- paste0(varindex, rep(yearsindex, each = length(varindex)))
varnames
neighborhoods %<>%
select(c(1:8, all_of(varnames)))
names(neighborhoods)
tracts1970 <- neighborhoods %>%
select(c(1:8, ends_with("70"))) %>%
mutate(Year = "1970")
tracts1980 <- neighborhoods %>%
select(c(1:8, ends_with("80"))) %>%
mutate(Year = "1980")
tracts1990 <- neighborhoods %>%
select(c(1:8, ends_with("90"))) %>%
mutate(Year = "1990")
tracts2000 <- neighborhoods %>%
select(c(1:8, ends_with("00"))) %>%
mutate(Year = "2000")
names(tracts1970) <- gsub("70", "", names(tracts1970))
names(tracts1980) <- gsub("80", "", names(tracts1980))
names(tracts1990) <- gsub("90", "", names(tracts1990))
names(tracts2000) <- gsub("00", "", names(tracts2000))
# adjust for inflation and make sure percentage variables are normal (between 0-100)
tracts1970 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), 0, hinc),
#        pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#        hu = ifelse(hu < 1 | is.na(hu), 1, hu)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["1970"]])) %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
summary(tracts1970)
# adjust for inflation and make sure percentage variables are normal (between 0-100)
tracts1980 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), 0, hinc),
#        pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#        hu = ifelse(hu < 1 | is.na(hu), 1, hu)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["1980"]])) %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
summary(tracts1980)
# adjust for inflation and make sure percentage variables are normal (between 0-100)
tracts1990 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), 0, hinc),
#        pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#        hu = ifelse(hu < 1 | is.na(hu), 1, hu)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["1990"]])) %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
summary(tracts1990)
# adjust for inflation and make sure percentage variables are normal
tracts2000 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc),
#        pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#        hu = ifelse(hu < 1 | is.na(hu), 1, hu)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2000"]])) %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
summary(tracts2000)
# make intervening years
tracts1971 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1971")
tracts1972 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1972")
tracts1973 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1973")
tracts1974 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1974")
tracts1975 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1975")
tracts1976 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1976")
tracts1977 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1977")
tracts1978 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1978")
tracts1979 <- tracts1970 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1979")
tracts1981 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1981")
tracts1982 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1982")
tracts1983 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1983")
tracts1984 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1984")
tracts1985 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1985")
tracts1986 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1986")
tracts1987 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1987")
tracts1988 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1988")
tracts1989 <- tracts1980 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1989")
tracts1991 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1991")
tracts1992 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1992")
tracts1993 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1993")
tracts1994 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1994")
tracts1995 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1995")
tracts1996 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1996")
tracts1997 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1997")
tracts1999 <- tracts2000 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "1999")
tracts7000 <- base::rbind(tracts1970, tracts1971, tracts1972, tracts1973, tracts1974, tracts1975, tracts1976, tracts1977, tracts1978, tracts1979, tracts1980, tracts1981, tracts1982, tracts1983, tracts1984, tracts1985, tracts1986, tracts1987, tracts1988, tracts1989, tracts1990, tracts1991, tracts1992, tracts1993, tracts1994, tracts1995, tracts1996, tracts1997, tracts1999, tracts2000)
rm(tracts1970, tracts1971, tracts1972, tracts1973, tracts1974, tracts1975, tracts1976, tracts1977, tracts1978, tracts1979, tracts1980, tracts1981, tracts1982, tracts1983, tracts1984, tracts1985, tracts1986, tracts1987, tracts1988, tracts1989, tracts1990, tracts1991, tracts1992, tracts1993, tracts1994, tracts1995, tracts1996, tracts1997, tracts1999)
summary(tracts7000)
# real interpolation 90-00 ####
# interpolate and then bottom-/top-code interpolated values
tracts7000 %<>%
group_by(trtid10) %>%
arrange(Year) %>%
mutate_at(all_of(varindex), ~na.approx(., na.rm = FALSE)) %>%
ungroup()
summary(tracts7000)
tracts7000 %<>%
mutate(prent = 100-pown)
tracts2010 <- neighborhoods %>%
select(c(1:8, ends_with("2a"))) %>%
mutate(Year = "2010")
names(tracts2010) <- gsub("2a", "", names(tracts2010))
tracts2010 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc),
#        pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#        hu = ifelse(hu < 1 | is.na(hu), 1, hu)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2010"]])) %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
summary(tracts2010)
tracts2001 <- tracts2010 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "2001")
tracts2002 <- tracts2010 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "2002")
tracts2003 <- tracts2010 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "2003")
tracts2004 <- tracts2010 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "2004")
tracts2005 <- tracts2010 %>%
mutate_at(all_of(varindex), ~NA) %>%
mutate(Year = "2005")
tracts2006 <- tracts2005 %>%
mutate(Year = "2006")
tracts2007 <- tracts2005 %>%
mutate(Year = "2007")
tracts2008 <- tracts2005 %>%
mutate(Year = "2008")
tracts2009 <- tracts2005 %>%
mutate(Year = "2009")
tracts0010 <- base::rbind(
tracts2000, tracts2001, tracts2002, tracts2003, tracts2004, tracts2005, tracts2006, tracts2007, tracts2008, tracts2009, tracts2010)
rm(tracts2000, tracts2001, tracts2002, tracts2003, tracts2004, tracts2005, tracts2006, tracts2007, tracts2008, tracts2009)
74001*11
summary(tracts0010)
# real interpolation 00-10 ####
# interpolate and then bottom-/top-code interpolated values
tracts0010 %<>%
group_by(trtid10) %>%
arrange(Year) %>%
mutate_at(all_of(varindex), ~na.approx(., na.rm = FALSE)) %>%
ungroup()
tracts0010 %<>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
tracts0010 %<>%
mutate(prent = 100-pown)
summary(tracts0010)
# 10-17 ####
# 2019 $
tracts2017 <- neighborhoods %>%
select(c(1:8, ends_with("9a")))
names(tracts2010)[9:25] <- str_c(names(tracts2010)[9:25], "2a")
vars_money9a <- str_c(vars_money, "9a")
varindex9a <- str_c(varindex, "9a")
# if a value is 0 at the beginning of the period, rate of change will be infinite
# those values need to be recoded to NA
tracts2017 %<>%
# mutate(mhmval9a = ifelse(is.na(mhmval9a), min(mhmval9a, na.rm = T), mhmval9a),
#        mrent9a = ifelse(is.na(mrent9a), min(mrent9a, na.rm = T), mrent9a),
#        hinc9a = ifelse(is.na(hinc9a), min(hinc9a, na.rm = T), hinc9a),
#        pop9a = ifelse(pop9a < 1 | is.na(pop9a), 1, pop9a),
#        hu9a = ifelse(hu9a < 1 | is.na(hu9a), 1, hu9a)) %>%
#mutate_at(all_of(varindex9a[c(3:length(varindex9a)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex9a[c(3:(length(varindex9a)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .)))
tracts1017 <- left_join(tracts2010, tracts2017 %>% select(trtid10, pop9a:hh9a), by = "trtid10")
rm(tracts2010, tracts2017)
summary(tracts1017)
# separate varindex for percent versus whole values ####
pctvarindex <- c("pnhwht", "pnhblk", "pmulti", "pcol", "ppov", "pprof",
"p20young", "pown", "pvac", "pfb")
varindex <- c("pop", "hu", "hh", "mhmval", "mrent", "hinc")
for (variable in pctvarindex) {
tracts1017[[paste0(variable, "_change")]] <-
((tracts1017[[paste0(variable, "9a")]] - tracts1017[[paste0(variable, "2a")]]))/7
tracts1017[[paste0(variable, "8a")]] <-
tracts1017[[paste0(variable, "9a")]]+tracts1017[[paste0(variable, "_change")]]
tracts1017[[paste0(variable, "2019")]] <-
tracts1017[[paste0(variable, "9a")]]+tracts1017[[paste0(variable, "_change")]]*2
}
for (variable in varindex) {
tracts1017[[paste0(variable, "_change")]] <-
((tracts1017[[paste0(variable, "9a")]] - tracts1017[[paste0(variable, "2a")]])/tracts1017[[paste0(variable, "2a")]])/7
tracts1017[[paste0(variable, "8a")]] <-
tracts1017[[paste0(variable, "9a")]]*(1+tracts1017[[paste0(variable, "_change")]])
tracts1017[[paste0(variable, "2019")]] <-
tracts1017[[paste0(variable, "9a")]]*(1+tracts1017[[paste0(variable, "_change")]])^2
}
tracts2017 <- tracts1017 %>%
select(c(1:8, ends_with("9a"))) %>%
mutate(Year = "2017",
prent9a = 100-pown9a)
names(tracts2017) <- gsub("9a", "", names(tracts2017))
# varindex of needed variables to top/bottom-code  ####
varindex <- c("pop", "hu", "pnhwht", "pnhblk", "pmulti", "pcol", "ppov", "pprof",
"p20young", "pown", "pvac", "pfb", "mhmval", "mrent", "hinc", "hh")
tracts2018 <- tracts1017 %>%
select(c(1:8, ends_with("8a")))
names(tracts2018) <- gsub("8a", "", names(tracts2018))
tracts2018 %<>%
mutate(#mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc),
#pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#hu = ifelse(hu < 1 | is.na(hu), 1, hu),
Year = "2018") %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .))) %>%
mutate(prent = 100-pown)
tracts2019 <- tracts1017 %>%
select(c(1:8, ends_with("2019")))
names(tracts2019) <- gsub("2019", "", names(tracts2019))
tracts2019 %<>%
mutate(#mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc),
#pop = ifelse(pop < 1 | is.na(pop), 1, pop),
#hu = ifelse(hu < 1 | is.na(hu), 1, hu),
Year = "2019") %>%
#mutate_at(all_of(varindex[c(3:length(varindex)-3)]), ~ifelse(is.na(.) | . < 0.1, 0.1, .)) %>%
mutate_at(all_of(varindex[c(3:(length(varindex)-4))]), ~ifelse(. > 100, 100,
ifelse(. < 0, 0, .))) %>%
mutate(prent = 100-pown)
tracts7019 <- base::rbind(tracts7000, tracts0010 %>% filter(Year != "2000"), tracts2017, tracts2018, tracts2019)
table(tracts7019$Year)
74001*43
tracts7019 %<>%
mutate_at(vars(pop, hu, hh), ~ifelse(!is.finite(.), NA, .))
summary(tracts7019)
# add in 2011-2016
neighborhoods <- read_csv('ltdb7010_acs1519_2010boundaries_merge_clean_full.csv')
#vars needed
#years needed
yearsindex <- c("3a", "4a", "5a", "6a", "7a", "8a")
varnames <- paste0(varindex, rep(yearsindex, each = length(varindex)))
varnames
neighborhoods %<>%
select(c(1:8, all_of(varnames)))
names(neighborhoods)
tracts2011 <- neighborhoods %>%
select(c(1:8, ends_with("3a"))) %>%
mutate(Year = "2011",
prent3a = 100-pown3a)
names(tracts2011) <- gsub("3a", "", names(tracts2011))
tracts2011 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2011"]]))
tracts2012 <- neighborhoods %>%
select(c(1:8, ends_with("4a"))) %>%
mutate(Year = "2012",
prent4a = 100-pown4a)
names(tracts2012) <- gsub("4a", "", names(tracts2012))
tracts2012 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2012"]]))
tracts2013 <- neighborhoods %>%
select(c(1:8, ends_with("5a"))) %>%
mutate(Year = "2013",
prent5a = 100-pown5a)
names(tracts2013) <- gsub("5a", "", names(tracts2013))
tracts2013 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2013"]]))
tracts2014 <- neighborhoods %>%
select(c(1:8, ends_with("6a"))) %>%
mutate(Year = "2014",
prent6a = 100-pown6a)
names(tracts2014) <- gsub("6a", "", names(tracts2014))
tracts2014 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2014"]]))
tracts2015 <- neighborhoods %>%
select(c(1:8, ends_with("7a"))) %>%
mutate(Year = "2015",
prent7a = 100-pown7a)
names(tracts2015) <- gsub("7a", "", names(tracts2015))
tracts2015 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2015"]]))
tracts2016 <- neighborhoods %>%
select(c(1:8, ends_with("8a"))) %>%
mutate(Year = "2016",
prent8a = 100-pown8a)
names(tracts2016) <- gsub("8a", "", names(tracts2016))
tracts2016 %<>%
# mutate(mhmval = ifelse(is.na(mhmval), min(mhmval, na.rm = T), mhmval),
#        mrent = ifelse(is.na(mrent), min(mrent, na.rm = T), mrent),
#        hinc = ifelse(is.na(hinc), min(hinc, na.rm = T), hinc)) %>%
mutate_at(all_of(vars_money), ~(.*cpi[["2016"]]))
tracts7019 <- base::rbind(tracts7019, tracts2011, tracts2012, tracts2013, tracts2014, tracts2015, tracts2016)
summary(tracts7019)
table(tracts7019$Year)
74001*49
rm(tracts2011, tracts2012, tracts2013, tracts2014, tracts2015, tracts2016, tracts0010, tracts1017, tracts2017, tracts2018, tracts2019)
tracts7019 %<>%
group_by(trtid10) %>%
arrange(Year) %>%
mutate_at(all_of(varindex), ~na.approx(., na.rm = FALSE)) %>%
ungroup()
tracts7019 %<>%
mutate(prent = ifelse(is.na(prent), 100-pown, prent))
summary(tracts7019)
cw <- read_csv("cbsa_stcou_2013_cw.csv")
cw %<>%
mutate(stcou = state*1000 + county,
stcou = str_pad(stcou, 5, "left", "0"),
msamd = ifelse(is.na(msamd), cbsa, msamd)) %>%
select(stcou, msamd)
tracts7019 %<>%
mutate(stcou = substr(trtid10, 1, 5)) %>%
left_join(cw, by = "stcou") %>%
rename(metdiv = msamd)
write_csv(tracts7019, "acs_7019.csv")
rm(tracts7000, neighborhoods)
rm(list = ls())
